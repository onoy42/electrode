<html>
  <head>
    <title>LogViewer: Electrode X application development logs</title>
    <style>
      /* styles from https://www.w3schools.com/howto/howto_css_fixed_menu.asp */
      /* The navigation bar */
      .navbar {
        overflow: hidden;
        background-color: #ffffff;
        position: fixed; /* Set the navbar to fixed position */
        top: 0; /* Position the navbar at the top of the page */
        width: 100%; /* Full width */
      }

      /* Links inside the navbar */
      .navbar a {
        /* color: #f2f2f2; */
        text-align: center;
        padding-left: 10px;
        padding-right: 10px;
      }

      /* Change background on mouse-over */
      .navbar a:hover {
        background: #1e9ae2;
        color: black;
      }

      /* Main content */
      .main {
        margin-top: 30px; /* Add a top margin to avoid content overlay */
        border-radius: 10px;
        background: black;
        color: gray;
        padding: 10px;
      }

      .logs {
        overflow-x: auto;
        white-space: pre-wrap;
        white-space: -moz-pre-wrap;
        white-space: -pre-wrap;
        white-space: -o-pre-wrap;
        word-wrap: break-word;
        font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
        font-size: small;
        line-height: normal;
      }

      .hide {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="controls" class="navbar">
      <button type="button" onclick="displayLogs();">Refresh Logs</button>
      <button type="button" onclick="wipeLogs();">Wipe Logs</button>
      <label>
        <input type="checkbox" id="level.error" checked onclick="levelChangeHandler();" />
        Error
      </label>
      <label>
        <input type="checkbox" id="level.warn" checked onclick="levelChangeHandler();" />
        Warn
      </label>
      <label>
        <input type="checkbox" id="level.info" checked onclick="levelChangeHandler();" />
        Info
      </label>
      <label>
        <input type="checkbox" id="level.http" checked onclick="levelChangeHandler();" />
        Http
      </label>
      <label>
        <input type="checkbox" id="level.verbose" checked onclick="levelChangeHandler();" />
        Verbose
      </label>
      <label>
        <input type="checkbox" id="level.debug" checked onclick="levelChangeHandler();" />
        Debug
      </label>
      <label>
        <input type="checkbox" id="level.silly" checked onclick="levelChangeHandler();" />
        Silly
      </label>
      <a href="/__electrode_dev" class="button">Dev Dashboard</a>
    </div>
    <div class="main">
      <pre class="logs" id="logs"></pre>
    </div>
    <script>
      const el = document.getElementById("logs");
      let logCount = 0;
      let currentHash = "";
      const defaultLevelSelections = {
        error: true,
        warn: true,
        info: true,
        http: true,
        verbose: true,
        debug: true,
        silly: true
      };

      function getLevelSelections() {
        const levels = Object.keys(defaultLevelSelections);
        const levelSelections = levels.reduce((acc, level) => {
          const checkBox = document.getElementById("level." + level);
          acc[level] = checkBox.checked;
          return acc;
        }, {});
        return { ...defaultLevelSelections, ...levelSelections };
      }

      function levelChangeHandler() {
        refreshLogs(getLevelSelections(), false);
      }

      function refreshLogs(levelSelections, scrollToEnd = true) {
        levelSelections = levelSelections || getLevelSelections();

        for (let line = el.firstChild; line !== null; line = line.nextSibling) {
          const lvl = line.getAttribute("lvl");
          if (!levelSelections[lvl]) {
            line.setAttribute("class", "hide");
          } else {
            line.removeAttribute("class");
          }
        }

        setValuesInHash(levelSelections);
      }

      function getHashValues() {
        const hash = window.location.hash;
        if (hash) {
          return hash
            .substr(1)
            .split("&")
            .reduce((acc, val) => {
              const kvp = val.split("=");
              if (kvp.length === 2 && kvp[0]) {
                acc[kvp[0]] = kvp[1];
              }
              return acc;
            }, {});
        }
        return {};
      }

      function getCountFromHash() {
        const info = getHashValues();
        if (info.count) {
          const count = parseInt(info.count, 10);
          if (Number.isInteger(count) && count >= 0) {
            return count;
          }
        } else {
          return 0;
        }
      }

      function setValuesInHash(values) {
        const info = { ...defaultLevelSelections, ...getHashValues(), ...values };
        currentHash = window.location.hash =
          "#" +
          Object.keys(info)
            .sort()
            .map(k => `${k}=${info[k]}`)
            .join("&");
      }

      function setCountInHash() {
        setValuesInHash({ count: logCount });
      }

      function wipeLogs() {
        setCountInHash();
        while (el.lastChild) {
          el.removeChild(el.lastChild);
        }
      }

      async function displayLogs(levelSelections, scrollToEnd = true) {
        levelSelections = levelSelections || getLevelSelections();
        const logResponse = await fetch(`/__electrode_dev/log-events`);
        let newLogs = await logResponse.json();
        const updateLogs = newLogs.slice(logCount, newLogs.length);

        if (updateLogs.length > 0) {
          updateLogs.forEach(event => {
            const newLine = document.createElement("div");
            newLine.setAttribute("lvl", event.level);
            if (!levelSelections[event.level]) {
              newLine.setAttribute("class", "hide");
            }
            newLine.innerHTML = event.message;
            el.appendChild(newLine);
          });
        }

        logCount += updateLogs.length;

        if (scrollToEnd) {
          setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 350);
        }
      }

      function updateLevelCheckboxes() {
        const info = { ...defaultLevelSelections, ...getLevelSelections(), ...getHashValues() };
        Object.keys(info).forEach(k => {
          const elem = document.getElementById(`level.${k}`);
          if (elem) {
            elem.checked = info[k] !== "false";
          }
        });
      }

      window.addEventListener(
        "hashchange",
        () => {
          if (currentHash !== window.location.hash) {
            currentHash = window.location.hash;
            updateLevelCheckboxes();
            const count = getCountFromHash();
            if (count !== logCount) {
              logCount = count;
              wipeLogs();
              displayLogs();
            } else {
              refreshLogs();
            }
          }
        },
        false
      );

      logCount = getCountFromHash();
      updateLevelCheckboxes();
      setTimeout(displayLogs, 10);
    </script>
  </body>
</html>
